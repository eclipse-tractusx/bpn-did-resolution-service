# Migration Guide `0.5.x -> 0.6.0`

This document outlines the necessary changes for migrating your bdrs installation from versions 0.5.x to 0.6.0.
It also outlines some points that adopters and operators should pay close attention to when migrating from one version
to another.

This document is not a comprehensive feature list.

<!-- TOC -->
* [Migration Guide `0.5.x -> 0.6.0`](#migration-guide-05x---060)
  * [1. Postgres Version](#1-postgres-version)
<!-- TOC -->

## 1. Postgres Version

The new version has been tested with Postgres version 18.0 instead of the formerly used version 16.x. With this change
there was also the switch from the no longer maintained Bitnami image and helm chart to helm charts provided by
Cloud Pirate which make use of the standard Postgres image published on Docker Hub.

As a consequence, for a Kubernetes setup done with the provided helm charts, there is no possibility to do an automatic
upgrade with the provided helm charts, as the two images are not supporting that. Instead, during update, a operator has
to do the following manual steps;

- Backup PostgreSQL data from the old installation
- Uninstall the old Helm release
- Delete the old PVC
- Perform a fresh installation with the new chart
- Restore data

The following snippets should give you the idea of the necessary steps during the update.

```bash
kubectl exec bdrs-server-postgresql-0 -- bash -c "PGPASSWORD=\$POSTGRES_PASSWORD pg_dumpall -U postgres" > /tmp/pg_backup.sql
helm uninstall bdrs-server
kubectl delete pvc data-bdrs-server-postgresql-0 --ignore-not-found=true
kubectl wait --for=delete statefulset/bdrs-server-postgresql --timeout=60s
kubectl wait --for=delete pvc/data-bdrs-server-postgresql-0 --timeout=60s

helm install bdrs-server charts/bdrs-server \
    --set server.debug.enabled="true" \
    --set server.image.pullPolicy="Never" \
    --set server.image.tag="latest" \
    --set server.image.repository="bdrs-server" \
    -f path/to/your/values.yaml \
    --wait-for-jobs --timeout=120s --dependency-update

kubectl exec -i bdrs-server-postgresql-0 -- bash -c "PGPASSWORD=\$POSTGRES_PASSWORD pg_restore -U postgres -C" < /tmp/pg_backup.sql
```
